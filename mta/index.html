<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transit Arrivals</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000000;
            color: #FFFFFF;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        .search-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #000000;
            padding: 20px;
            border-bottom: 3px solid #FFDD00;
            z-index: 1000;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-container input {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            background: #1a1a1a;
            border: 2px solid #FFDD00;
            color: #FFFFFF;
            border-radius: 4px;
        }

        .search-container input::placeholder {
            color: #888;
        }

        .search-container button {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            background: #FFDD00;
            color: #000000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-container button:hover {
            background: #FFE44D;
        }

        .search-container button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }

        .status-message {
            position: fixed;
            top: 90px;
            left: 20px;
            right: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-left: 4px solid #FFDD00;
            border-radius: 4px;
            z-index: 999;
        }

        .board-container {
            margin-top: 150px;
            padding: 20px;
            height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .stop-group {
            margin-bottom: 40px;
        }

        .stop-header {
            font-size: 24px;
            font-weight: bold;
            color: #FFDD00;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }

        .stop-distance {
            font-size: 16px;
            color: #999;
            font-weight: normal;
            margin-left: 15px;
        }

        .arrivals-grid {
            display: grid;
            gap: 10px;
        }

        .arrival-row {
            background: #1a1a1a;
            padding: 15px 20px;
            border-left: 5px solid;
            display: grid;
            grid-template-columns: 80px 1fr 120px;
            align-items: center;
            gap: 20px;
        }

        .route-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 60px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 24px;
            text-align: center;
            padding: 5px;
        }

        .route-max { background: #0039A6; color: white; }
        .route-bus { background: #6CBE45; color: white; }
        .route-streetcar { background: #EC1E24; color: white; }
        .route-tram { background: #FF6319; color: white; }

        .destination {
            font-size: 20px;
            font-weight: 500;
        }

        .arrival-time {
            text-align: right;
            font-size: 32px;
            font-weight: bold;
            color: #FFDD00;
        }

        .arrival-time.now {
            color: #FF6319;
        }

        .arrival-time.soon {
            color: #FFE44D;
        }

        .no-arrivals {
            background: #1a1a1a;
            padding: 30px;
            text-align: center;
            color: #999;
            font-size: 18px;
            border: 2px dashed #333;
        }

        .clock {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #FFDD00;
            z-index: 1001;
        }

        .error-message {
            background: #FF6319;
            color: white;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #FFDD00;
            border-radius: 5px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-top: 3px solid #FFDD00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="addressInput" placeholder="Enter address (e.g., 1234 SW Broadway, Portland, OR)">
        <button id="searchBtn">Find Transit</button>
    </div>

    <div class="clock" id="clock"></div>

    <div id="statusMessage" class="status-message" style="display: none;"></div>

    <div class="board-container" id="boardContainer">
        <div class="no-arrivals">
            Enter an address above to find nearby transit arrivals
        </div>
    </div>

    <script>
        const TRIMET_APP_ID = '1319D2D75C06E60EB3071D522';
        const REFRESH_INTERVAL = 15000; // 15 seconds
        let currentLocation = null;
        let refreshTimer = null;

        // Update clock
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            document.getElementById('clock').textContent = timeStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Show status message
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message' + (isError ? ' error-message' : '');
            statusEl.style.display = 'block';

            if (!isError) {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // Geocode address using Nominatim
        async function geocodeAddress(address) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'StatusBoard Transit App'
                    }
                });
                const data = await response.json();

                if (data.length === 0) {
                    throw new Error('Address not found');
                }

                return {
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon),
                    display_name: data[0].display_name
                };
            } catch (error) {
                console.error('Geocoding error:', error);
                throw error;
            }
        }

        // Find nearby TriMet stops
        async function findNearbyStops(lat, lon, radiusMeters = 500) {
            const url = `https://developer.trimet.org/ws/V1/stops?ll=${lat},${lon}&meters=${radiusMeters}&appID=${TRIMET_APP_ID}&json=true`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!data.resultSet || !data.resultSet.location) {
                    return [];
                }

                const stops = Array.isArray(data.resultSet.location)
                    ? data.resultSet.location
                    : [data.resultSet.location];

                // Calculate distances and sort by closest
                return stops.map(stop => ({
                    ...stop,
                    distance: calculateDistance(lat, lon, stop.lat, stop.lng)
                })).sort((a, b) => a.distance - b.distance);
            } catch (error) {
                console.error('Error finding stops:', error);
                return [];
            }
        }

        // Calculate distance between two points (in meters)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Get arrivals for stops
        async function getArrivals(stopIds) {
            const url = `https://developer.trimet.org/ws/v2/arrivals?locIDs=${stopIds.join(',')}&appID=${TRIMET_APP_ID}&arrivals=6&minutes=60&json=true`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error getting arrivals:', error);
                return null;
            }
        }

        // Determine transit mode from route info
        function getTransitMode(arrival) {
            const route = arrival.shortSign || '';
            const routeNum = arrival.route || '';

            if (arrival.routeSubType === 'Streetcar' || arrival.streetCar) {
                return 'streetcar';
            }

            if (['90', '100', '190', '200', '290'].includes(routeNum) ||
                arrival.routeType === 'R' ||
                arrival.routeSubType === 'Light Rail') {
                return 'max';
            }

            if (arrival.routeSubType === 'Aerial Tram') {
                return 'tram';
            }

            return 'bus';
        }

        // Format arrival time
        function formatArrivalTime(minutes) {
            if (minutes <= 1) {
                return 'NOW';
            } else if (minutes <= 5) {
                return minutes + ' min';
            } else {
                return minutes + ' min';
            }
        }

        // Get time class for styling
        function getTimeClass(minutes) {
            if (minutes <= 1) return 'now';
            if (minutes <= 5) return 'soon';
            return '';
        }

        // Render arrivals board
        function renderBoard(stops, arrivalsData) {
            const container = document.getElementById('boardContainer');

            if (!stops || stops.length === 0) {
                container.innerHTML = '<div class="no-arrivals">No transit stops found within 500m of this location</div>';
                return;
            }

            const arrivalsByStop = {};

            if (arrivalsData && arrivalsData.resultSet && arrivalsData.resultSet.arrival) {
                const arrivals = Array.isArray(arrivalsData.resultSet.arrival)
                    ? arrivalsData.resultSet.arrival
                    : [arrivalsData.resultSet.arrival];

                arrivals.forEach(arrival => {
                    const stopId = arrival.locid;
                    if (!arrivalsByStop[stopId]) {
                        arrivalsByStop[stopId] = [];
                    }
                    arrivalsByStop[stopId].push(arrival);
                });
            }

            let html = '';

            // Show up to 5 closest stops
            stops.slice(0, 5).forEach(stop => {
                const arrivals = arrivalsByStop[stop.locid] || [];
                const distanceFt = Math.round(stop.distance * 3.28084);
                const distanceDisplay = distanceFt < 528
                    ? `${distanceFt} ft`
                    : `${(distanceFt / 5280).toFixed(1)} mi`;

                html += `
                    <div class="stop-group">
                        <div class="stop-header">
                            ${stop.desc}
                            <span class="stop-distance">${distanceDisplay}</span>
                        </div>
                        <div class="arrivals-grid">
                `;

                if (arrivals.length === 0) {
                    html += '<div class="no-arrivals">No arrivals scheduled</div>';
                } else {
                    arrivals.forEach(arrival => {
                        const mode = getTransitMode(arrival);
                        const minutes = Math.round((arrival.estimated - Date.now()) / 60000);
                        const routeNum = arrival.route || '?';
                        const destination = arrival.shortSign || arrival.fullSign || 'Unknown';

                        // Determine border color based on mode
                        const borderColors = {
                            'max': '#0039A6',
                            'bus': '#6CBE45',
                            'streetcar': '#EC1E24',
                            'tram': '#FF6319'
                        };

                        html += `
                            <div class="arrival-row" style="border-left-color: ${borderColors[mode]}">
                                <div class="route-badge route-${mode}">${routeNum}</div>
                                <div class="destination">${destination}</div>
                                <div class="arrival-time ${getTimeClass(minutes)}">${formatArrivalTime(minutes)}</div>
                            </div>
                        `;
                    });
                }

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Main search and display function
        async function searchAndDisplay() {
            const address = document.getElementById('addressInput').value.trim();

            if (!address) {
                showStatus('Please enter an address', true);
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="loading-spinner"></span>';

            try {
                // Step 1: Geocode address
                showStatus('Finding location...');
                const location = await geocodeAddress(address);
                currentLocation = location;

                // Step 2: Find nearby stops
                showStatus('Finding nearby transit stops...');
                const stops = await findNearbyStops(location.lat, location.lon);

                if (stops.length === 0) {
                    showStatus('No transit stops found within 500m', true);
                    renderBoard([], null);
                    return;
                }

                // Step 3: Get arrivals
                showStatus('Loading arrivals...');
                const stopIds = stops.slice(0, 5).map(s => s.locid);
                const arrivalsData = await getArrivals(stopIds);

                // Step 4: Render board
                renderBoard(stops, arrivalsData);
                showStatus(`Found ${stops.length} nearby stop${stops.length !== 1 ? 's' : ''}`);

                // Step 5: Start auto-refresh
                if (refreshTimer) {
                    clearInterval(refreshTimer);
                }
                refreshTimer = setInterval(() => refreshArrivals(stops), REFRESH_INTERVAL);

            } catch (error) {
                console.error('Search error:', error);
                showStatus('Error: ' + error.message, true);
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Find Transit';
            }
        }

        // Refresh arrivals for current stops
        async function refreshArrivals(stops) {
            if (!stops || stops.length === 0) return;

            try {
                const stopIds = stops.slice(0, 5).map(s => s.locid);
                const arrivalsData = await getArrivals(stopIds);
                renderBoard(stops, arrivalsData);
            } catch (error) {
                console.error('Refresh error:', error);
            }
        }

        // Event listeners
        document.getElementById('searchBtn').addEventListener('click', searchAndDisplay);
        document.getElementById('addressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchAndDisplay();
            }
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
        });
    </script>
</body>
</html>
