<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>South Waterfront Live Ticker</title>
  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --card: #020617;
      --card-border: #1f2937;
      --accent-bus: #22c55e;
      --accent-tram: #eab308;
      --accent-max: #3b82f6;
      --accent-streetcar: #ec4899;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --danger: #f97316;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617 40%);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
      perspective: 2000px; /* for screen flip effect */
    }

    .header {
      padding: 1rem 1.5rem 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .title {
      font-size: clamp(1.8rem, 3vw, 2.5rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .status-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.25rem;
      font-size: 0.85rem;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.85rem;
    }

    .logo-block {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.25), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.6);
      overflow: hidden;
    }

    .torch-logo {
      max-width: 32px;
      max-height: 32px;
      display: block;
    }

    .clock-display {
      font-variant-numeric: tabular-nums;
      font-size: 2rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-main);
      text-align: right;
    }

    .status-pill {
      padding: 0.15rem 0.65rem;
      border-radius: 999px;
      border: 1px solid #16a34a33;
      color: var(--success);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .status-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
    }

    .last-updated {
      color: var(--text-muted);
    }

    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      grid-template-rows: minmax(0, 1fr);
      gap: 1rem;
      padding: 0.75rem 1.5rem 1.25rem;
      transform-style: preserve-3d;
    }

    .layout.screen-flip {
      animation: flipScreen 0.8s ease-in-out;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(2, minmax(0, 1fr));
      }
    }

    .panel {
      position: relative;
      border-radius: 1.5rem;
      padding: 1rem 1.25rem;
      border: 1px solid var(--card-border);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.16), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.9), rgba(3, 7, 18, 0.98));
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.7);
    }

    .panel-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .panel-title {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-tagline {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .panel-pill {
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      border: 1px solid currentColor;
      opacity: 0.9;
    }

    .panel-bus { color: var(--accent-bus); }
    .panel-tram { color: var(--accent-tram); }
    .panel-max { color: var(--accent-max); }
    .panel-streetcar { color: var(--accent-streetcar); }

    .tram-weather {
      margin-top: 0.25rem;
      margin-bottom: 0.35rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .tram-weather-header {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
    }

    .tram-weather-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .tram-weather-tile {
      border-radius: 1rem;
      padding: 0.55rem 0.6rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      align-items: flex-start;
      min-width: 0;
    }

    .tram-weather-time {
      font-variant-numeric: tabular-nums;
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .tram-weather-main {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .tram-weather-icon {
      font-size: 1.35rem;
    }

    .tram-weather-temp {
      font-size: 1rem;
      font-weight: 600;
    }

    .tram-weather-wind {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    @media (max-width: 900px) {
      .tram-weather-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .rows {
      margin-top: 0.35rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.95rem;
      flex: 1;
      justify-content: space-evenly;
    }

    .row {
      display: grid;
      grid-template-columns: 0.35fr 0.65fr 0.35fr;
      align-items: center;
      gap: 0.75rem;
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(31, 41, 55, 0.9);
      backdrop-filter: blur(10px);
      transform-origin: center center;
      transform-style: preserve-3d;
    }

    /* NEW: split-flap cascading animation */
    .row.split-flap-animate,
    .row-header.split-flap-animate {
      animation: splitFlap 0.6s ease-out forwards;
    }

    @keyframes splitFlap {
      0% {
        transform: rotateX(90deg);
        opacity: 0;
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.7);
      }
      40% {
        transform: rotateX(-15deg);
        opacity: 1;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
      }
      100% {
        transform: rotateX(0deg);
        opacity: 1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      }
    }

    @keyframes flipScreen {
      0%   { transform: rotateX(90deg);  opacity: 0; }
      50%  { transform: rotateX(-10deg); opacity: 1; }
      100% { transform: rotateX(0deg);   opacity: 1; }
    }

    .row.placeholder {
      opacity: 0.35;
      border-style: dashed;
      box-shadow: none;
      animation: none;
    }

    .row-header {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
      opacity: 0.85;
      transform-origin: center center;
      transform-style: preserve-3d;
    }

    .row-dim {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .chip-line {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2.2rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid currentColor;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    .chip-time {
      display: inline-flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.4rem;
      font-variant-numeric: tabular-nums;
    }

    .chip-time span:first-child {
      font-weight: 600;
    }

    .pill-soon {
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(234, 179, 8, 0.55);
      color: #eab308;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .pill-now {
      border-color: rgba(34, 197, 94, 0.65);
      color: #22c55e;
    }

    .pill-delayed {
      border-color: rgba(249, 115, 22, 0.75);
      color: #f97316;
    }

    .empty-state {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 0.25rem;
    }

    .ticker-footer {
      padding: 0.25rem 1.5rem 0.75rem;
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid rgba(31, 41, 55, 0.85);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.98));
    }

    .ticker-footer span strong {
      font-weight: 600;
      color: #e5e7eb;
    }

    .hint {
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo-block">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/d/d1/OHSU-RGB-4C-POS.png"
          alt="OHSU torch logo"
          class="torch-logo"
          onerror="this.style.display='none'"
        />
      </div>
      <div class="title-block">
        <div class="subtitle">Trimet ¬∑ Portland, OR</div>
        <div class="title-row">
          <div class="title">South Waterfront Station</div>
          <div class="clock-display" id="live-clock">--:--:--</div>
        </div>
      </div>
    </div>
    <div class="status-block">
      <div class="status-pill">
        <span class="status-dot"></span>
        <span id="mode-label">Live Board</span>
      </div>
      <div class="last-updated" id="last-updated">Initializing‚Ä¶</div>
    </div>
  </header>

  <main class="layout">
    <section class="panel" id="panel-bus">
      <div class="panel-header">
        <div>
          <div class="panel-title panel-bus">Bus</div>
          <div class="panel-tagline">Next three departures</div>
        </div>
        <div class="panel-pill panel-bus">Lines &amp; route names</div>
      </div>
      <div class="row-header">LINE ¬∑ DESTINATION ¬∑ TIME</div>
      <div class="rows" id="rows-bus"></div>
      <div class="empty-state" id="empty-bus" hidden>No live bus arrivals for this stop right now.</div>
    </section>

    <section class="panel" id="panel-tram">
      <div class="panel-header">
        <div>
          <div class="panel-title panel-tram">Aerial Tram &amp; Weather</div>
          <div class="panel-tagline">Next 3 hours ¬∑ South Waterfront</div>
        </div>
        <div class="panel-pill panel-tram">Forecast ¬∑ Hours ¬∑ Frequency</div>
      </div>

      <div class="tram-weather">
        <div class="tram-weather-header">Hourly forecast</div>
        <div class="tram-weather-grid" id="tram-weather-grid"></div>
      </div>

      <div class="row-header">DAYS ¬∑ SERVICE ¬∑ FREQUENCY</div>
      <div class="rows" id="rows-tram"></div>
      <div class="empty-state" id="empty-tram" hidden>Tram service not currently running.</div>
    </section>

    <section class="panel" id="panel-max">
      <div class="panel-header">
        <div>
          <div class="panel-title panel-max">MAX</div>
          <div class="panel-tagline">Next three trains</div>
        </div>
        <div class="panel-pill panel-max">Line ¬∑ Destination ¬∑ Time</div>
      </div>
      <div class="row-header">LINE ¬∑ DESTINATION ¬∑ TIME</div>
      <div class="rows" id="rows-max"></div>
      <div class="empty-state" id="empty-max" hidden>No live MAX arrivals for this platform right now.</div>
    </section>

    <section class="panel" id="panel-streetcar">
      <div class="panel-header">
        <div>
          <div class="panel-title panel-streetcar">Streetcar</div>
          <div class="panel-tagline">Next three cars</div>
        </div>
        <div class="panel-pill panel-streetcar">Line ¬∑ Direction ¬∑ Time</div>
      </div>
      <div class="row-header">LINE ¬∑ DESTINATION ¬∑ TIME</div>
      <div class="rows" id="rows-streetcar"></div>
      <div class="empty-state" id="empty-streetcar" hidden>No live Streetcar arrivals for this stop right now.</div>
    </section>
  </main>

  <footer class="ticker-footer">
    <span>
      Data source: <strong>TriMet &amp; OHSU Aerial Tram</strong> ¬∑ Times are estimates.
    </span>
    <span class="hint" id="slide-timer">Page 1/2 ¬∑ Next in 15s</span>
  </footer>

  <script>
    const USE_LIVE_TRIMET = true;
    const ENABLE_WEATHER = true;
    const TRIMET_APP_ID = "1319D2D75C06E60EB3071D522";

    const CONFIG = {
      bus: {
        title: "Bus",
        color: "bus",
        stops: [
          { id: 13732, label: "South Waterfront/S Moody ¬∑ Westbound" },
          { id: 13733, label: "South Waterfront/S Moody ¬∑ Eastbound" }
        ]
      },
      max: {
        title: "MAX",
        color: "max",
        stops: [
          { id: 13728, label: "MAX Orange ¬∑ To City Center / Expo" },
          { id: 13711, label: "MAX Orange ¬∑ To Milwaukie" }
        ]
      },
      streetcar: {
        title: "Streetcar",
        color: "streetcar",
        stops: [
          { id: 13602, label: "Streetcar ¬∑ S Moody & Meade North" },
          { id: 13601, label: "Streetcar ¬∑ S Moody & Meade South" }
        ]
      }
    };

    const MAX_ROUTE_NUMBERS = new Set(["90", "100", "190", "200", "290"]);

    const WEATHER_LAT = 45.499;
    const WEATHER_LON = -122.671;
    const WEATHER_HOURS_AHEAD = 3;
    const WEATHER_REFRESH_MINUTES = 10;

    const REFRESH_SECONDS = 30;
    const MAX_ROWS_PER_PANEL = 7;
    const SLIDES = [["bus", "tram"], ["max", "streetcar"]];
    const SLIDE_SECONDS = 15;
    let currentSlide = 0;
    let slideCountdown = SLIDE_SECONDS;
    let isSlideAnimating = false;

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
    }

    function minutesUntil(targetDate) {
      const diffMs = targetDate.getTime() - Date.now();
      return Math.round(diffMs / 60000);
    }

    function classifyPill(mins) {
      if (mins <= 0) return "now";
      if (mins <= 3) return "soon";
      if (mins >= 20) return "delayed";
      return "";
    }

    function pillClass(pill) {
      if (pill === "now") return "pill-soon pill-now";
      if (pill === "soon") return "pill-soon";
      if (pill === "delayed") return "pill-soon pill-delayed";
      return "pill-soon";
    }

    function updateClock() {
      const clock = document.getElementById("live-clock");
      if (!clock) return;
      const now = new Date();
      clock.textContent = now.toLocaleTimeString([], {
        hour: "numeric",
        minute: "2-digit",
        second: "2-digit"
      });
    }

    function updateLastUpdated(success) {
      const el = document.getElementById("last-updated");
      const modeLabel = document.getElementById("mode-label");
      const now = new Date();
      if (el) {
        el.textContent = success
          ? `Updated ${now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" })}`
          : `Update error at ${now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" })}`;
      }
      if (modeLabel) modeLabel.textContent = "Live Board";
    }

    function mapWeatherCodeToIcon(code) {
      if (code === 0) return { icon: "‚òÄÔ∏è", label: "Clear" };
      if (code === 1 || code === 2) return { icon: "üå§Ô∏è", label: "Mostly clear" };
      if (code === 3) return { icon: "‚òÅÔ∏è", label: "Cloudy" };
      if (code >= 45 && code <= 48) return { icon: "üå´Ô∏è", label: "Fog" };
      if (code >= 51 && code <= 67) return { icon: "üå¶Ô∏è", label: "Rain" };
      if (code >= 71 && code <= 77) return { icon: "‚ùÑÔ∏è", label: "Snow" };
      if (code >= 80 && code <= 82) return { icon: "üåßÔ∏è", label: "Showers" };
      if (code >= 95) return { icon: "‚õàÔ∏è", label: "Storm" };
      return { icon: "üå°Ô∏è", label: "Weather" };
    }

    async function fetchWeatherForecast() {
      const url = new URL("https://api.open-meteo.com/v1/forecast");
      url.searchParams.set("latitude", WEATHER_LAT);
      url.searchParams.set("longitude", WEATHER_LON);
      url.searchParams.set("hourly", "temperature_2m,wind_speed_10m,weathercode");
      url.searchParams.set("forecast_days", "1");
      url.searchParams.set("timezone", "auto");

      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
      const data = await res.json();
      return data;
    }

    function renderTramWeather(data) {
      const grid = document.getElementById("tram-weather-grid");
      if (!grid) return;
      grid.innerHTML = "";

      if (!data || !data.hourly || !Array.isArray(data.hourly.time)) {
        const span = document.createElement("div");
        span.textContent = "Weather data unavailable";
        span.style.fontSize = "0.8rem";
        span.style.color = "var(--text-muted)";
        grid.appendChild(span);
        return;
      }

      const { time, temperature_2m, wind_speed_10m, weathercode } = data.hourly;
      const now = Date.now();
      const forecasts = [];

      for (let i = 0; i < time.length; i++) {
        const t = Date.parse(time[i]);
        if (isNaN(t) || t < now) continue;
        forecasts.push({
          when: new Date(t),
          temp: temperature_2m?.[i],
          wind: wind_speed_10m?.[i],
          code: weathercode?.[i]
        });
      }

      forecasts.sort((a, b) => a.when - b.when);
      const used = forecasts.slice(0, WEATHER_HOURS_AHEAD);

      if (used.length === 0) {
        const span = document.createElement("div");
        span.textContent = "No upcoming forecast hours";
        span.style.fontSize = "0.8rem";
        span.style.color = "var(--text-muted)";
        grid.appendChild(span);
        return;
      }

      for (const f of used) {
        const tile = document.createElement("div");
        tile.className = "tram-weather-tile";

        const timeEl = document.createElement("div");
        timeEl.className = "tram-weather-time";
        timeEl.textContent = f.when.toLocaleTimeString([], { hour: "numeric" });

        const main = document.createElement("div");
        main.className = "tram-weather-main";

        const iconEl = document.createElement("div");
        iconEl.className = "tram-weather-icon";
        const { icon, label } = mapWeatherCodeToIcon(f.code);
        iconEl.textContent = icon;

        const tempEl = document.createElement("div");
        tempEl.className = "tram-weather-temp";
        const tempRounded = typeof f.temp === "number" ? Math.round((f.temp * 9) / 5 + 32) : f.temp;
        tempEl.textContent = tempRounded != null ? `${tempRounded}¬∞` : "--¬∞";

        main.appendChild(iconEl);
        main.appendChild(tempEl);

        const windEl = document.createElement("div");
        windEl.className = "tram-weather-wind";
        const windRounded = typeof f.wind === "number" ? Math.round(f.wind * 0.621371) : f.wind;
        windEl.textContent = windRounded != null ? `Wind ${windRounded} mph` : "Wind --";

        const labelEl = document.createElement("div");
        labelEl.className = "tram-weather-wind";
        labelEl.textContent = label;

        tile.appendChild(timeEl);
        tile.appendChild(main);
        tile.appendChild(windEl);
        tile.appendChild(labelEl);

        grid.appendChild(tile);
      }
    }

    async function refreshWeather() {
      const grid = document.getElementById("tram-weather-grid");
      if (!grid) return;

      try {
        if (!ENABLE_WEATHER) {
          grid.innerHTML = "";
          const span = document.createElement("div");
          span.textContent = "Weather preview disabled";
          span.style.fontSize = "0.8rem";
          span.style.color = "var(--text-muted)";
          grid.appendChild(span);
          return;
        }

        const data = await fetchWeatherForecast();
        renderTramWeather(data);
      } catch (err) {
        console.error("Error fetching weather:", err);
        grid.innerHTML = "";
        const span = document.createElement("div");
        span.textContent = "Weather data unavailable";
        span.style.fontSize = "0.8rem";
        span.style.color = "var(--text-muted)";
        grid.appendChild(span);
      }
    }

    async function fetchArrivalsForStops(locIDs) {
      if (!USE_LIVE_TRIMET) return null;
      if (!TRIMET_APP_ID) throw new Error("TriMet appID missing");

      const ids = Array.from(new Set(locIDs));
      const url = new URL("https://developer.trimet.org/ws/v2/arrivals");
      url.searchParams.set("appID", TRIMET_APP_ID);
      url.searchParams.set("locIDs", ids.join(","));
      url.searchParams.set("json", "true");
      url.searchParams.set("arrivals", "4");
      url.searchParams.set("minutes", "60");

      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error(`TriMet API error: ${res.status}`);
      const data = await res.json();
      return data.resultSet || data.result || data;
    }

    function normalizeTriMetArrivals(resultSet) {
      const byStop = new Map();
      const routeIndex = new Map();
      const locationIndex = new Map();

      if (Array.isArray(resultSet.route)) {
        for (const r of resultSet.route) {
          if (r.route != null) routeIndex.set(String(r.route), r);
        }
      }

      if (Array.isArray(resultSet.location)) {
        for (const loc of resultSet.location) {
          const id = loc.id ?? loc.locid;
          if (id != null) locationIndex.set(Number(id), loc);
        }
      }

      const arrivals = Array.isArray(resultSet.arrival) ? resultSet.arrival : [];

      for (const a of arrivals) {
        const locid = Number(a.locid ?? a.locID ?? a.locationId);
        if (!locid) continue;

        const routeId = a.route != null ? String(a.route) : null;
        const routeInfo = routeId ? routeIndex.get(routeId) : null;

        const routeType = routeInfo?.type || null;
        const routeSubType = routeInfo?.routeSubType || null;
        const streetCarFlag = !!(a.streetCar || a.nextBusFeed);
        const isMaxRouteNumber = routeId && MAX_ROUTE_NUMBERS.has(routeId);

        let mode = "bus";
        if (streetCarFlag || routeSubType === "Streetcar") {
          mode = "streetcar";
        } else if (routeSubType === "Aerial Tram") {
          mode = "tram";
        } else if (routeSubType === "Light Rail" || routeType === "R" || isMaxRouteNumber) {
          mode = "max";
        }

        const whenMs = a.estimated ?? a.scheduled;
        if (!whenMs) continue;

        const loc = locationIndex.get(locid);
        const headsign = a.fullSign || a.shortSign || loc?.desc || "";

        const entry = {
          stopId: locid,
          line: routeId || a.blockID || "?",
          headsign,
          when: new Date(whenMs),
          status: a.status || "",
          mode,
          routeType,
          routeSubType,
          streetCarFlag
        };

        if (!byStop.has(locid)) byStop.set(locid, []);
        byStop.get(locid).push(entry);
      }

      for (const [, arr] of byStop.entries()) {
        arr.sort((a, b) => a.when - b.when);
      }

      return byStop;
    }

    function applySplitFlapAnimation(el, index, baseDelay = 0.05) {
      if (!el) return;
      el.classList.remove("split-flap-animate");
      void el.offsetWidth;
      el.style.animationDelay = `${(index * baseDelay).toFixed(2)}s`;
      el.classList.add("split-flap-animate");
    }

    function animatePanelHeader(kind) {
      const header = document.querySelector(`#panel-${kind} .row-header`);
      if (header) {
        applySplitFlapAnimation(header, 0, 0);
      }
    }

    function createRowElement(entry, indexInPanel) {
      const mins = minutesUntil(entry.when);
      const pill = classifyPill(mins);

      const row = document.createElement("div");
      row.className = "row";
      applySplitFlapAnimation(row, indexInPanel);

      const colLine = document.createElement("div");
      const chipLine = document.createElement("div");
      chipLine.className = "chip-line";
      chipLine.textContent = entry.line;
      colLine.appendChild(chipLine);

      const colDest = document.createElement("div");
      colDest.textContent = entry.headsign;

      const colTime = document.createElement("div");
      colTime.className = "chip-time";

      const timeLabel = document.createElement("span");
      const minsLabel = document.createElement("span");

      timeLabel.textContent = formatTime(entry.when);
      minsLabel.textContent = mins <= 0 ? "Now" : `${mins} min`;

      colTime.appendChild(timeLabel);
      colTime.appendChild(minsLabel);

      if (pill) {
        const pillSpan = document.createElement("span");
        pillSpan.className = pillClass(pill);
        pillSpan.textContent = pill.toUpperCase();
        colTime.appendChild(pillSpan);
      }

      row.appendChild(colLine);
      row.appendChild(colDest);
      row.appendChild(colTime);
      return row;
    }

    function createPlaceholderRow() {
      const row = document.createElement("div");
      row.className = "row placeholder";

      const colLine = document.createElement("div");
      const chipLine = document.createElement("div");
      chipLine.className = "chip-line";
      chipLine.textContent = "‚Äî";
      colLine.appendChild(chipLine);

      const colDest = document.createElement("div");
      colDest.textContent = "";

      const colTime = document.createElement("div");
      colTime.className = "chip-time";
      const timeLabel = document.createElement("span");
      const minsLabel = document.createElement("span");
      timeLabel.textContent = "‚Äî";
      minsLabel.textContent = "";
      colTime.appendChild(timeLabel);
      colTime.appendChild(minsLabel);

      row.appendChild(colLine);
      row.appendChild(colDest);
      row.appendChild(colTime);
      return row;
    }

    function renderVehiclePanel(kind, byStopMap, config, filterFn) {
      const rowsEl = document.getElementById(`rows-${kind}`);
      const emptyEl = document.getElementById(`empty-${kind}`);
      if (!rowsEl || !emptyEl) return;
      rowsEl.innerHTML = "";

      const entries = [];
      for (const stop of config.stops) {
        const arr = byStopMap?.get?.(stop.id) || [];
        for (const a of arr) {
          if (!filterFn || filterFn(a, stop, config)) {
            entries.push({ ...a });
          }
        }
      }

      entries.sort((a, b) => a.when - b.when);
      const used = entries.slice(0, MAX_ROWS_PER_PANEL);

      emptyEl.hidden = used.length > 0;

      used.forEach((e, idx) => {
        rowsEl.appendChild(createRowElement(e, idx));
      });

      const placeholdersNeeded = Math.max(0, MAX_ROWS_PER_PANEL - used.length);
      for (let i = 0; i < placeholdersNeeded; i++) {
        rowsEl.appendChild(createPlaceholderRow());
      }

      animatePanelHeader(kind);
    }

    function generateTramSchedule() {
      const rowsEl = document.getElementById("rows-tram");
      const emptyEl = document.getElementById("empty-tram");
      if (!rowsEl || !emptyEl) return;
      rowsEl.innerHTML = "";

      const rows = [
        {
          label: "Weekdays",
          service: "South Waterfront ‚áÑ OHSU",
          details: "5:30 am ‚Äì 9:30 pm ¬∑ Every 5‚Äì10 min"
        },
        {
          label: "Saturday",
          service: "South Waterfront ‚áÑ OHSU",
          details: "9:00 am ‚Äì 5:00 pm ¬∑ Every ~5 min"
        },
        {
          label: "Sunday / Holidays",
          service: "No regular service",
          details: "Check GoByTram.com for exceptions"
        }
      ];

      rows.forEach((r, idx) => {
        const row = document.createElement("div");
        row.className = "row";
        applySplitFlapAnimation(row, idx);

        const colLine = document.createElement("div");
        const chipLine = document.createElement("div");
        chipLine.className = "chip-line";
        chipLine.textContent = r.label;
        colLine.appendChild(chipLine);

        const colDest = document.createElement("div");
        colDest.textContent = r.service;

        const colTime = document.createElement("div");
        colTime.className = "chip-time";
        const timeLabel = document.createElement("span");
        timeLabel.textContent = r.details;
        colTime.appendChild(timeLabel);

        row.appendChild(colLine);
        row.appendChild(colDest);
        row.appendChild(colTime);
        rowsEl.appendChild(row);
      });

      const currentCount = rowsEl.childElementCount;
      const placeholdersNeeded = Math.max(0, MAX_ROWS_PER_PANEL - currentCount);
      for (let i = 0; i < placeholdersNeeded; i++) {
        rowsEl.appendChild(createPlaceholderRow());
      }

      emptyEl.hidden = true;
      emptyEl.style.display = "none";
      animatePanelHeader("tram");
    }

    function runSanityTests() {
      const streetcarFilter = (a) =>
        a.mode === "streetcar" || a.routeSubType === "Streetcar" || a.streetCarFlag;
      const fakeStreetcar = { mode: "streetcar", routeSubType: "Streetcar", streetCarFlag: true };
      const fakeBus = { mode: "bus", routeSubType: "Bus", streetCarFlag: false };

      console.assert(streetcarFilter(fakeStreetcar) === true, "Streetcar filter should accept streetcar entries");
      console.assert(streetcarFilter(fakeBus) === false, "Streetcar filter should reject bus entries");

      console.assert(classifyPill(-1) === "now", "classifyPill(-1) should be 'now'");
      console.assert(classifyPill(2) === "soon", "classifyPill(2) should be 'soon'");
      console.assert(classifyPill(25) === "delayed", "classifyPill(25) should be 'delayed'");

      const now = new Date();
      const inFive = new Date(now.getTime() + 5 * 60000);
      const mins = minutesUntil(inFive);
      console.assert(Math.abs(mins - 5) <= 1, "minutesUntil should be ~5 for +5min");

      const sunny = mapWeatherCodeToIcon(0);
      console.assert(sunny.icon === "‚òÄÔ∏è" && sunny.label === "Clear", "Weather code 0 should map to Clear/‚òÄÔ∏è");
    }

    function updateSlideTimer() {
      const el = document.getElementById("slide-timer");
      if (!el) return;
      if (isSlideAnimating) {
        el.textContent = `Page ${currentSlide + 1}/${SLIDES.length} ¬∑ Flipping‚Ä¶`;
      } else {
        el.textContent = `Page ${currentSlide + 1}/${SLIDES.length} ¬∑ Next in ${slideCountdown}s`;
      }
    }

    function showSlide(idx, options) {
      const animate = !options || options.animate !== false;
      currentSlide = ((idx % SLIDES.length) + SLIDES.length) % SLIDES.length;

      const allKinds = ["bus", "tram", "max", "streetcar"];
      for (const kind of allKinds) {
        const panel = document.getElementById(`panel-${kind}`);
        if (!panel) continue;
        panel.style.display = SLIDES[currentSlide].includes(kind) ? "flex" : "none";
      }

      const layout = document.querySelector(".layout");
      if (animate && layout) {
        isSlideAnimating = true;
        layout.classList.add("screen-flip");
        updateSlideTimer();

        layout.addEventListener(
          "animationend",
          () => {
            layout.classList.remove("screen-flip");
            isSlideAnimating = false;
            slideCountdown = SLIDE_SECONDS;
            updateSlideTimer();
          },
          { once: true }
        );
      } else {
        isSlideAnimating = false;
        slideCountdown = SLIDE_SECONDS;
        updateSlideTimer();
      }
    }

    function slideTick() {
      if (isSlideAnimating) {
        updateSlideTimer();
        return;
      }
      slideCountdown -= 1;
      if (slideCountdown <= 0) {
        showSlide(currentSlide + 1, { animate: true });
      } else {
        updateSlideTimer();
      }
    }

    async function refreshBoard() {
      const allLocIds = [
        ...CONFIG.bus.stops.map((s) => s.id),
        ...CONFIG.max.stops.map((s) => s.id),
        ...CONFIG.streetcar.stops.map((s) => s.id)
      ];

      try {
        const resultSet = await fetchArrivalsForStops(allLocIds);
        if (!resultSet) {
          const emptyMap = new Map();
          const streetcarFilter = (a) =>
            a.mode === "streetcar" || a.routeSubType === "Streetcar" || a.streetCarFlag;
          const maxFilter = (a) => {
            const line = String(a.line || "");
            const isMaxRoute = MAX_ROUTE_NUMBERS.has(line);
            const isRail = a.routeType === "R" || a.routeSubType === "Light Rail";
            return a.mode === "max" || isRail || isMaxRoute;
          };
          renderVehiclePanel("bus", emptyMap, CONFIG.bus, (a) => a.mode === "bus");
          renderVehiclePanel("max", emptyMap, CONFIG.max, maxFilter);
          renderVehiclePanel("streetcar", emptyMap, CONFIG.streetcar, streetcarFilter);
          generateTramSchedule();
          updateLastUpdated(false);
          return;
        }

        const byStop = normalizeTriMetArrivals(resultSet);
        const streetcarFilter = (a) =>
          a.mode === "streetcar" || a.routeSubType === "Streetcar" || a.streetCarFlag;
        const maxFilter = (a) => {
          const line = String(a.line || "");
          const isMaxRoute = MAX_ROUTE_NUMBERS.has(line);
          const isRail = a.routeType === "R" || a.routeSubType === "Light Rail";
          return a.mode === "max" || isRail || isMaxRoute;
        };

        renderVehiclePanel("bus", byStop, CONFIG.bus, (a) => a.mode === "bus");
        renderVehiclePanel("max", byStop, CONFIG.max, maxFilter);
        renderVehiclePanel("streetcar", byStop, CONFIG.streetcar, streetcarFilter);
        generateTramSchedule();
        updateLastUpdated(true);
      } catch (err) {
        console.error("Error refreshing board:", err);
        const emptyMap = new Map();
        const streetcarFilter = (a) =>
          a.mode === "streetcar" || a.routeSubType === "Streetcar" || a.streetCarFlag;
        const maxFilter = (a) => {
          const line = String(a.line || "");
          const isMaxRoute = MAX_ROUTE_NUMBERS.has(line);
          const isRail = a.routeType === "R" || a.routeSubType === "Light Rail";
          return a.mode === "max" || isRail || isMaxRoute;
        };
        renderVehiclePanel("bus", emptyMap, CONFIG.bus, (a) => a.mode === "bus");
        renderVehiclePanel("max", emptyMap, CONFIG.max, maxFilter);
        renderVehiclePanel("streetcar", emptyMap, CONFIG.streetcar, streetcarFilter);
        generateTramSchedule();
        updateLastUpdated(false);
      }
    }

    function init() {
      runSanityTests();
      updateClock();
      setInterval(updateClock, 1000);

      showSlide(0, { animate: false });
      updateSlideTimer();
      setInterval(slideTick, 1000);

      refreshBoard();
      setInterval(refreshBoard, REFRESH_SECONDS * 1000);

      refreshWeather();
      setInterval(refreshWeather, WEATHER_REFRESH_MINUTES * 60 * 1000);
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
